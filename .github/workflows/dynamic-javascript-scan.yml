
name: "JavaScript Security Scan"
on:
  workflow_dispatch:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  REPORT_DIR: scan-reports

jobs:
  javascript-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "18"
        cache: ${{ hashFiles('package-lock.json') != '' && 'npm' || '' }}
        
    - name: Install dependencies
      run: |
        if [ -f "package.json" ]; then
          npm install
        else
          echo "No package.json found, skipping npm install"
        fi
        
    - name: Install scanning tools
      run: |
        npm install -g eslint npm-audit-ci retire plato jsdoc jscpd
        
    - name: Create report directory
      run: |
        mkdir -p $REPORT_DIR
        
    - name: Run security and quality scans
      run: |
        echo 'Starting JavaScript security scan...'
        echo 'Running ESLint...'
        echo '{"extends": ["eslint:recommended"], "env": {"browser": true, "node": true}, "parserOptions": {"ecmaVersion": 2018}}' > .eslintrc.json && eslint . --format=json --output-file=$REPORT_DIR/eslint.json 2>/dev/null || echo '[]' > $REPORT_DIR/eslint.json
        echo 'Running Plato Complexity Analysis...'
        plato -r -d $REPORT_DIR/plato . 2>/dev/null || (mkdir -p $REPORT_DIR/plato && echo '{"reports": {}}' > $REPORT_DIR/plato/report.json)
        
    - name: Initialize severity summary
      run: |
        echo '{"critical": [], "high": [], "medium": [], "low": [], "info": []}' > $REPORT_DIR/severity_summary.json
        
    - name: Debug scan results
      run: |
        echo "=== DEBUG: Check scan results ==="
        echo "Report directory contents:"
        ls -la $REPORT_DIR/
        echo ""
        echo "=== ESLint results ==="
        if [ -f "$REPORT_DIR/eslint.json" ]; then
          echo "ESLint file exists:"
          cat $REPORT_DIR/eslint.json
        else
          echo "ESLint file NOT found"
        fi
        echo ""
        echo "=== Plato results ==="
        if [ -f "$REPORT_DIR/plato/report.json" ]; then
          echo "Plato file exists:"
          cat $REPORT_DIR/plato/report.json
        else
          echo "Plato file NOT found"
          echo "Plato directory contents:"
          ls -la $REPORT_DIR/plato/ 2>/dev/null || echo "Plato directory not found"
        fi
        echo ""
        echo "=== Severity summary before processing ==="
        if [ -f "$REPORT_DIR/severity_summary.json" ]; then
          cat $REPORT_DIR/severity_summary.json
        else
          echo "Severity summary file NOT found"
        fi
        
    - name: Run JavaScript processing script
      run: |
        node << 'SCRIPT_EOF'
        const fs = require('fs');
        const path = require('path');

        const reportDir = process.env.REPORT_DIR || 'scan-reports';
        let severitySummary = {
            "critical": [],
            "high": [],
            "medium": [],
            "low": [],
            "info": []
        };

        console.log('Report directory:', reportDir);
        console.log('Files in report directory:');
        try {
            const files = fs.readdirSync(reportDir);
            console.log(files);
        } catch (e) {
            console.log('Error reading directory:', e);
        }

        try {
            console.log('Checking npm_audit.json...');
            if (fs.existsSync(reportDir + '/npm_audit.json')) {
                console.log('Found npm_audit.json');
                const npmData = JSON.parse(fs.readFileSync(reportDir + '/npm_audit.json', 'utf8'));
                if (npmData.vulnerabilities) {
                    npmData.vulnerabilities.forEach(vuln => {
                        const severity = vuln.severity ? vuln.severity.toLowerCase() : 'unknown';
                        if (severitySummary[severity]) {
                            severitySummary[severity].push({
                                'tool': 'npm_audit',
                                'package': vuln.module_name,
                                'version': (vuln.findings && vuln.findings.length > 0) ? vuln.findings[0].version : 'N/A',
                                'issue': vuln.title,
                                'message': vuln.overview || 'Vulnerability found'
                            });
                        }
                    });
                }
            } else {
                console.log('npm_audit.json not found');
            }
        } catch (e) {
            console.log('Error processing npm_audit.json: ' + e);
        }

        try {
            console.log('Checking eslint.json...');
            if (fs.existsSync(reportDir + '/eslint.json')) {
                console.log('Found eslint.json');
                const eslintData = JSON.parse(fs.readFileSync(reportDir + '/eslint.json', 'utf8'));
                console.log('ESLint data length:', eslintData.length);
                eslintData.forEach(result => {
                    if (result.severity === 2) { // error
                        severitySummary.high.push({
                            'tool': 'eslint',
                            'file': result.filePath,
                            'line': result.lineNumber,
                            'issue': result.ruleId,
                            'message': result.message || 'ESLint error'
                        });
                    } else if (result.severity === 1) { // warning
                        severitySummary.medium.push({
                            'tool': 'eslint',
                            'file': result.filePath,
                            'line': result.lineNumber,
                            'issue': result.ruleId,
                            'message': result.message || 'ESLint warning'
                        });
                    }
                });
            } else {
                console.log('eslint.json not found');
            }
        } catch (e) {
            console.log('Error processing eslint.json: ' + e);
        }

        // Process Plato results
        try {
            console.log('Checking plato/report.json...');
            if (fs.existsSync(reportDir + '/plato/report.json')) {
                console.log('Found plato/report.json');
                const platoData = JSON.parse(fs.readFileSync(reportDir + '/plato/report.json', 'utf8'));
                Object.keys(platoData.reports).forEach(file => {
                    const report = platoData.reports[file];
                    if (report.complexity && report.complexity.aggregate.complexity.cyclomatic > 10) {
                        severitySummary.medium.push({
                            'tool': 'plato',
                            'file': file,
                            'issue': 'High complexity',
                            'message': 'Cyclomatic complexity: ' + report.complexity.aggregate.complexity.cyclomatic
                        });
                    }
                });
            } else {
                console.log('plato/report.json not found');
            }
        } catch (e) {
            console.log('Error processing plato/report.json: ' + e);
        }

        // Process Retire.js results
        try {
            console.log('Checking retire.json...');
            if (fs.existsSync(reportDir + '/retire.json')) {
                console.log('Found retire.json');
                const retireData = JSON.parse(fs.readFileSync(reportDir + '/retire.json', 'utf8'));
                retireData.data.forEach(vuln => {
                    if (vuln.severity === 'high' || vuln.severity === 'critical') {
                        severitySummary[vuln.severity].push({
                            'tool': 'retire',
                            'package': vuln.component,
                            'version': vuln.version,
                            'issue': vuln.identifiers.join(', '),
                            'message': vuln.info.join(', ')
                        });
                    } else if (vuln.severity === 'medium') {
                        severitySummary.medium.push({
                            'tool': 'retire',
                            'package': vuln.component,
                            'version': vuln.version,
                            'issue': vuln.identifiers.join(', '),
                            'message': vuln.info.join(', ')
                        });
                    }
                });
            } else {
                console.log('retire.json not found');
            }
        } catch (e) {
            console.log('Error processing retire.json: ' + e);
        }

        // Process JSCPD results
        try {
            console.log('Checking jscpd.json...');
            if (fs.existsSync(reportDir + '/jscpd.json')) {
                console.log('Found jscpd.json');
                const jscpdData = JSON.parse(fs.readFileSync(reportDir + '/jscpd.json', 'utf8'));
                jscpdData.duplications.forEach(dup => {
                    if (dup.lines > 50) {
                        severitySummary.low.push({
                            'tool': 'jscpd',
                            'file': dup.file,
                            'issue': 'Code duplication',
                            'message': dup.lines + ' duplicated lines found'
                        });
                    }
                });
            } else {
                console.log('jscpd.json not found');
            }
        } catch (e) {
            console.log('Error processing jscpd.json: ' + e);
        }

        // Process JSDoc results
        try {
            console.log('Checking jsdoc.json...');
            if (fs.existsSync(reportDir + '/jsdoc.json')) {
                console.log('Found jsdoc.json');
                const jsdocData = JSON.parse(fs.readFileSync(reportDir + '/jsdoc.json', 'utf8'));
                if (jsdocData.errors && jsdocData.errors.length > 0) {
                    severitySummary.low.push({
                        'tool': 'jsdoc',
                        'issue': 'Documentation errors',
                        'message': jsdocData.errors.length + ' documentation errors found'
                    });
                } else if (jsdocData.warnings && jsdocData.warnings.length > 0) {
                    severitySummary.info.push({
                        'tool': 'jsdoc',
                        'issue': 'Documentation warnings',
                        'message': jsdocData.warnings.length + ' documentation warnings found'
                    });
                }
            } else {
                console.log('jsdoc.json not found');
            }
        } catch (e) {
            console.log('Error processing jsdoc.json: ' + e);
        }

        console.log('Final severity summary:', JSON.stringify(severitySummary, null, 2));
        fs.writeFileSync(reportDir + '/severity_summary.json', JSON.stringify(severitySummary, null, 2));
        console.log("JavaScript severity summary generated successfully");
        console.log('=== FINAL DEBUG: severity_summary.json contents ===');
        console.log(fs.readFileSync(reportDir + '/severity_summary.json', 'utf8'));
        SCRIPT_EOF
        
    - name: Debug final results
      run: |
        echo "=== DEBUG: Final severity summary ==="
        if [ -f "$REPORT_DIR/severity_summary.json" ]; then
          echo "Final severity summary file contents:"
          cat $REPORT_DIR/severity_summary.json
        else
          echo "Final severity summary file NOT found"
        fi
        
    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: javascript-scan-reports
        path: ${{ env.REPORT_DIR }}/
        retention-days: 30
        
    - name: Generate scan summary
      run: |
        echo "## JavaScript Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "### Severity Summary" >> $GITHUB_STEP_SUMMARY
        echo "'json'" >> $GITHUB_STEP_SUMMARY
        cat $REPORT_DIR/severity_summary.json >> $GITHUB_STEP_SUMMARY
        echo "'json'" >> $GITHUB_STEP_SUMMARY
        
        echo "### Available Reports" >> $GITHUB_STEP_SUMMARY
        echo "- npm-audit: 'npm_audit.json'" >> $GITHUB_STEP_SUMMARY
        echo "- ESLint: 'eslint.json'" >> $GITHUB_STEP_SUMMARY
        echo "- Plato: 'plato.json'" >> $GITHUB_STEP_SUMMARY
        echo "- JSDoc: 'jsdoc'" >> $GITHUB_STEP_SUMMARY
        echo "- JSCPD: 'jscpd.json'" >> $GITHUB_STEP_SUMMARY
        echo "- Retire.js: 'retire.json'" >> $GITHUB_STEP_SUMMARY
        echo "- Severity Summary: 'severity_summary.json'" >> $GITHUB_STEP_SUMMARY
        
        echo "### Repository Information" >> $GITHUB_STEP_SUMMARY
        echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        
        echo "### Timestamp" >> $GITHUB_STEP_SUMMARY
        echo "- Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
      shell: bash

    - name: Send results to API
      if: always()
      run: |
        if [ -f "$REPORT_DIR/severity_summary.json" ]; then
          curl -X POST \
            -H "Content-Type: application/json" \
            -d @- \
            "https://eop7f15rcm9dnz.m.pipedream.net" << EOF
        {
          "repository": "${{ github.repository }}",
          "branch": "${{ github.ref_name }}",
          "run_id": "${{ github.run_id }}",
          "severity_results": $(cat $REPORT_DIR/severity_summary.json),
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF
        fi
      shell: bash
