
name: Dynamic JavaScript Code Scan

on:
  workflow_dispatch:
    inputs:
      scan_tools:
        description: 'Comma-separated list of tools to run'
        required: false
        default: 'eslint,plato'
      project_name:
        description: 'Project name for reporting'
        required: false
        default: 'javascript-project'

env:
  REPORT_DIR: scan-reports

jobs:
  javascript-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm install -g npm eslint@8 jscpd retire plato jsdoc
        echo "Verifying installations:"
        which eslint || echo "eslint not found in PATH"
        which plato || echo "plato not found in PATH"
        which retire || echo "retire not found in PATH"
        which jscpd || echo "jscpd not found in PATH"
        which jsdoc || echo "jsdoc not found in PATH"
        echo ""
        echo "Version checks:"
        eslint --version || echo "eslint version failed"
        plato --version || echo "plato version failed"
        retire --version || echo "retire version failed"
        jscpd --version || echo "jscpd version failed"
        jsdoc --version || echo "jsdoc version failed"
        
    - name: Create report directory
      run: mkdir -p $REPORT_DIR

    - name: Create ESLint config
      run: |
        cat > .eslintrc.json << 'EOF'
        {
          "env": {
            "browser": true,
            "es2021": true,
            "node": true,
            "commonjs": true
          },
          "extends": ["eslint:recommended"],
          "parserOptions": {
            "ecmaVersion": 12,
            "sourceType": "commonjs"
          },
          "rules": {
            "no-var": "error",
            "semi": "error",
            "no-unused-vars": "error",
            "no-alert": "error",
            "quotes": ["error", "double"],
            "no-undef": "error"
          }
        }
        EOF

    - name: Run JavaScript code scans
      run: |
        echo "Starting JavaScript code scans..."
        echo "Current directory: $(pwd)"
        echo "Report directory: $REPORT_DIR"
        echo "JavaScript files found:"
        find . -name "*.js" -type f | head -10 || echo "No JavaScript files found"
        echo "Package.json exists:"
        test -f package.json && echo "✅ package.json found" || echo "❌ package.json not found"
        echo "Node modules exists:"
        test -d node_modules && echo "✅ node_modules found" || echo "❌ node_modules not found"
        echo "=== Running Scan Commands ==="
        echo "DEBUG: About to execute scan_commands..."
                echo 'Running NPM Audit...' && npm install --silent || echo 'npm install failed' && npm audit --json > $REPORT_DIR/npm_audit.json || (echo 'npm audit failed' && echo '{"vulnerabilities": []}' > $REPORT_DIR/npm_audit.json)

        echo 'Running ESLint...' && eslint . -f json -o $REPORT_DIR/eslint.json || echo 'ESLint failed' && echo '{}' > $REPORT_DIR/eslint.json

        echo 'Running JSCPD...' && jscpd . --reporters json --output $REPORT_DIR/jscpd.json || echo 'jscpd failed' && echo '{"files":[],"total":{"lines":0,"tokens":0,"duplicates":0,"percentage":0}}' > $REPORT_DIR/jscpd.json

        echo 'Running Retire.js...' && retire --outputformat json --outputpath $REPORT_DIR/retire.json || echo 'retire failed' && echo '{}' > $REPORT_DIR/retire.json

        echo 'Running Plato...' && plato -r -d $REPORT_DIR/plato-report . || echo 'plato failed' && mkdir -p $REPORT_DIR/plato-report && echo '{}' > $REPORT_DIR/plato-report/report.json

        echo 'Running JSDoc...' && jsdoc . -X > $REPORT_DIR/jsdoc.json || echo 'jsdoc failed' && echo '{"documentation": "failed"}' > $REPORT_DIR/jsdoc.json
        echo "DEBUG: scan_commands completed"
        echo "=== Scan Commands Completed ==="
        echo "Report directory contents after scans:"
        ls -la $REPORT_DIR/ || echo "Report directory not accessible"
        echo "=== Checking each tool's report file ==="
        for file in eslint.json npm_audit.json retire.json jscpd.json jsdoc.json; do
          if [ -f "$REPORT_DIR/$file" ]; then
            echo "✅ $file exists ($(wc -c < $REPORT_DIR/$file) bytes)"
          else
            echo "❌ $file missing"
          fi
        done
        if [ -f "$REPORT_DIR/plato-report/report.json" ]; then
          echo "✅ plato-report/report.json exists ($(wc -c < $REPORT_DIR/plato-report/report.json) bytes)"
        else
          echo "❌ plato-report/report.json missing"
        fi
        
    - name: Generate severity summary
      run: |
        python3 << 'PYEOF'
        import json
        import os
        from pathlib import Path
        
        report_dir = Path(os.environ.get('REPORT_DIR', 'scan-reports'))
        print('DEBUG: Report directory: ' + str(report_dir))
        print('DEBUG: Report directory exists: ' + str(report_dir.exists()))
        print('DEBUG: Report directory contents: ' + str(list(report_dir.glob('*'))))
        
        # Check which report files exist
        report_files = ['eslint.json', 'npm_audit.json', 'retire.json', 'jscpd.json', 'jsdoc.json']
        for file_name in report_files:
            file_path = report_dir / file_name
            if file_path.exists():
                print('DEBUG: ' + file_name + ' exists with size: ' + str(file_path.stat().st_size))
            else:
                print('DEBUG: ' + file_name + ' does not exist')
        
        # Check plato report directory
        plato_dir = report_dir / 'plato-report'
        if plato_dir.exists():
            print('DEBUG: plato-report directory exists')
            report_file = plato_dir / 'report.json'
            if report_file.exists():
                print('DEBUG: plato-report/report.json exists with size: ' + str(report_file.stat().st_size))
            else:
                print('DEBUG: plato-report/report.json does not exist')
        else:
            print('DEBUG: plato-report directory does not exist')
        
        severity_summary = dict()
        severity_summary['critical'] = []
        severity_summary['high'] = []
        severity_summary['medium'] = []
        severity_summary['low'] = []
        severity_summary['info'] = []

        # Process ESLint results
        eslint_file = report_dir / 'eslint.json'
        if eslint_file.exists() and eslint_file.stat().st_size > 0:
            try:
                with open(eslint_file) as f:
                    eslint_data = json.load(f)
                    print('DEBUG: ESLint data loaded: ' + str(len(eslint_data)) + ' files processed')
                    for result in eslint_data:
                        if result.get('errorCount', 0) > 0 or result.get('warningCount', 0) > 0:
                            for message in result.get('messages', []):
                                severity = 'high' if message.get('severity') == 2 else 'medium'
                                severity_summary[severity].append(dict(
                                    tool='eslint',
                                    file='./' + result.get('filePath', '').lstrip('./'),
                                    line=message.get('line'),
                                    column=message.get('column'),
                                    issue=message.get('ruleId'),
                                    message=message.get('message')
                                ))
                    print('DEBUG: ESLint severity summary: ' + str(severity_summary))
            except Exception as e:
                print('Error processing eslint.json: ' + str(e))
                print('DEBUG: ESLint file content preview:')
                try:
                    with open(report_dir / 'eslint.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print('DEBUG: ' + content)
                except:
                    print('DEBUG: Could not read eslint.json file')
        else:
            print('DEBUG: eslint.json file not found or empty')

        # Process NPM Audit results
        npm_audit_file = report_dir / 'npm_audit.json'
        if npm_audit_file.exists() and npm_audit_file.stat().st_size > 0:
            try:
                with open(npm_audit_file) as f:
                    npm_audit_data = json.load(f)
                    print('DEBUG: NPM Audit data loaded: ' + str(len(npm_audit_data.get('vulnerabilities', []))) + ' vulnerabilities found')
                    print('DEBUG: NPM Audit raw data structure: ' + str(list(npm_audit_data.keys()) if isinstance(npm_audit_data, dict) else type(npm_audit_data)))

                    vuln_count = 0
                    for vuln in npm_audit_data.get('vulnerabilities', []):
                        vuln_count += 1
                        print('DEBUG: Processing vulnerability: ' + str(vuln))

                        # Map npm-audit severity to our severity levels
                        audit_severity = vuln.get('severity', 'unknown').lower()
                        print('DEBUG: Audit severity: ' + audit_severity)
                        if audit_severity in ['critical', 'high']:
                            severity = 'critical'
                        elif audit_severity in ['medium', 'moderate']:
                            severity = 'high'
                        elif audit_severity in ['low']:
                            severity = 'medium'
                        else:
                            severity = 'low'

                        print('DEBUG: Mapped severity: ' + severity)
                        if severity in severity_summary:
                            severity_summary[severity].append(dict(
                                tool='npm_audit',
                                file='./package.json',
                                line=1,  # NPM Audit doesn't provide line numbers, use 1 as default
                                issue=vuln.get('name', 'unknown-package'),
                                message=vuln.get('title', 'Security vulnerability'),
                                severity=vuln.get('severity', 'unknown'),
                                url=vuln.get('url', 'No URL')
                            ))
                    print('DEBUG: Total vulnerabilities processed: ' + str(vuln_count))
                    print('DEBUG: NPM Audit severity summary: ' + str(severity_summary))
            except Exception as e:
                print('Error processing npm_audit.json: ' + str(e))
                print('DEBUG: NPM Audit file content preview:')
                try:
                    with open(report_dir / 'npm_audit.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print('DEBUG: ' + content)
                except:
                    print('DEBUG: Could not read npm_audit.json file')
        else:
            print('DEBUG: npm_audit.json file not found or empty')

        # Process Retire.js results
        retire_file = report_dir / 'retire.json'
        if retire_file.exists() and retire_file.stat().st_size > 0:
            try:
                with open(retire_file) as f:
                    retire_data = json.load(f)
                    print('DEBUG: Retire.js data loaded: ' + str(len(retire_data.get('data', []))) + ' components found')
                    print('DEBUG: Retire.js raw data structure: ' + str(list(retire_data.keys()) if isinstance(retire_data, dict) else type(retire_data)))

                    vuln_count = 0
                    for component in retire_data.get('data', []):
                        if 'vulnerabilities' in component and component['vulnerabilities']:
                            print('DEBUG: Found vulnerable component: ' + component.get('component', 'unknown'))
                            for vuln in component['vulnerabilities']:
                                vuln_count += 1
                                print('DEBUG: Processing vulnerability: ' + str(vuln))

                                # Map retire severity to our severity levels
                                retire_severity = vuln.get('severity', 'unknown').lower()
                                print('DEBUG: Retire severity: ' + retire_severity)
                                if retire_severity in ['critical', 'high']:
                                    severity = 'critical'
                                elif retire_severity in ['medium', 'moderate']:
                                    severity = 'high'
                                elif retire_severity in ['low']:
                                    severity = 'medium'
                                else:
                                    severity = 'low'

                                print('DEBUG: Mapped severity: ' + severity)
                                if severity in severity_summary:
                                    severity_summary[severity].append(dict(
                                        tool='retire',
                                        file='./' + component.get('file', 'unknown').lstrip('./'),
                                        line=1,  # Retire.js doesn't provide line numbers, use 1 as default
                                        issue=component.get('component', 'unknown-component'),
                                        message=vuln.get('identifiers', {}).get('summary', 'Security vulnerability'),
                                        severity=vuln.get('severity', 'unknown'),
                                        info=vuln.get('info', 'No additional info')
                                    ))
                    print('DEBUG: Total retire vulnerabilities processed: ' + str(vuln_count))
                    print('DEBUG: Retire.js severity summary: ' + str(severity_summary))
            except Exception as e:
                print('Error processing retire.json: ' + str(e))
                print('DEBUG: Retire.js file content preview:')
                try:
                    with open(report_dir / 'retire.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print('DEBUG: ' + content)
                except:
                    print('DEBUG: Could not read retire.json file')
        else:
            print('DEBUG: retire.json file not found or empty')

        # Process Plato complexity results
        plato_report_file = plato_dir / 'report.json'
        if plato_report_file.exists() and plato_report_file.stat().st_size > 0:
            try:
                with open(plato_dir / 'report.json') as f:
                    plato_data = json.load(f)
                    print('DEBUG: Plato data loaded')
                    print('DEBUG: Plato raw data structure: ' + str(list(plato_data.keys()) if isinstance(plato_data, dict) else type(plato_data)))

                    # Process complexity reports if available
                    reports = plato_data.get('reports', [])
                    for report_item in reports:
                        if isinstance(report_item, dict):
                            file_path = './' + report_item.get('info', {}).get('file', 'unknown').lstrip('./')
                            metrics = report_item
                            complexity = metrics.get('complexity', {}).get('methodAggregate', {}).get('cyclomatic', 0)
                            maintainability = metrics.get('maintainability', 0)

                            # High complexity issues
                            if complexity > 10:
                                severity_summary['high'].append(dict(
                                    tool='plato',
                                    file=file_path,
                                    line=1,  # Plato doesn't provide line numbers, use 1 as default
                                    issue='high_complexity',
                                    message='Cyclomatic complexity: ' + str(complexity)
                                ))
                            elif complexity > 5:
                                severity_summary['medium'].append(dict(
                                    tool='plato',
                                    file=file_path,
                                    line=1,  # Plato doesn't provide line numbers, use 1 as default
                                    issue='medium_complexity',
                                    message='Cyclomatic complexity: ' + str(complexity)
                                ))

                            # Low maintainability issues
                            if maintainability < 60:
                                severity_summary['medium'].append(dict(
                                    tool='plato',
                                    file=file_path,
                                    line=1,  # Plato doesn't provide line numbers, use 1 as default
                                    issue='low_maintainability',
                                    message='Maintainability score: ' + str(maintainability)
                                ))
                            elif maintainability < 80:
                                severity_summary['low'].append(dict(
                                    tool='plato',
                                    file=file_path,
                                    line=1,  # Plato doesn't provide line numbers, use 1 as default
                                    issue='medium_maintainability',
                                    message='Maintainability score: ' + str(maintainability)
                                ))

                    print('DEBUG: Plato severity summary: ' + str(severity_summary))

            except Exception as e:
                print('Error processing plato report: ' + str(e))
                print('DEBUG: Plato file content preview:')
                try:
                    with open(plato_dir / 'report.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print('DEBUG: ' + content)
                except:
                    print('DEBUG: Could not read plato report.json file')
        else:
            print('DEBUG: plato-report/report.json file not found')
        
        # Process JSCPD results
        jscpd_file = report_dir / 'jscpd.json'
        if jscpd_file.exists() and jscpd_file.stat().st_size > 0:
            try:
                with open(jscpd_file) as f:
                    jscpd_data = json.load(f)
                    print('DEBUG: JSCPD data loaded')
                    print('DEBUG: JSCPD raw data structure: ' + str(list(jscpd_data.keys()) if isinstance(jscpd_data, dict) else type(jscpd_data)))
                    
                    # Process duplication results
                    total_duplicates = jscpd_data.get('total', {}).get('duplicates', 0)
                    total_lines = jscpd_data.get('total', {}).get('lines', 0)
                    percentage = jscpd_data.get('total', {}).get('percentage', 0)
                    
                    if total_duplicates > 0:
                        severity = 'high' if percentage > 10 else 'medium' if percentage > 5 else 'low'
                        severity_summary[severity].append(dict(
                            tool='jscpd',
                            file='./',
                            line=1,
                            issue='code_duplication',
                            message=f'Found {total_duplicates} duplicates ({percentage:.1f}% of code)'
                        ))
                    
                    print('DEBUG: JSCPD severity summary: ' + str(severity_summary))
            except Exception as e:
                print('Error processing jscpd.json: ' + str(e))
        else:
            print('DEBUG: jscpd.json file not found or empty')
        
        # Process JSDoc results
        jsdoc_file = report_dir / 'jsdoc.json'
        if jsdoc_file.exists() and jsdoc_file.stat().st_size > 0:
            try:
                with open(report_dir / 'jsdoc.json') as f:
                    jsdoc_data = json.load(f)
                    print('DEBUG: JSDoc data loaded')
                    print('DEBUG: JSDoc raw data structure: ' + str(list(jsdoc_data.keys()) if isinstance(jsdoc_data, dict) else type(jsdoc_data)))
                    
                    # Check if documentation was generated successfully
                    if isinstance(jsdoc_data, dict) and jsdoc_data:
                        severity_summary['info'].append(dict(
                            tool='jsdoc',
                            file='./',
                            line=1,
                            issue='documentation_generated',
                            message='JSDoc documentation generated successfully'
                        ))
                    
                    print('DEBUG: JSDoc severity summary: ' + str(severity_summary))
            except Exception as e:
                print('Error processing jsdoc.json: ' + str(e))
        else:
            print('DEBUG: jsdoc.json file not found or empty')
        
        # Save severity summary
        output_file = report_dir / 'severity_summary.json'
        with open(output_file, 'w') as f:
            json.dump(severity_summary, f, indent=2)

        print('=== FINAL SEVERITY SUMMARY ===')
        for severity, issues in severity_summary.items():
            print(str(severity) + ': ' + str(len(issues)) + ' issues')
        print('Severity summary saved to: ' + str(output_file))
        PYEOF
        
    - name: Verify scan outputs
      run: |
        ls -R $REPORT_DIR
        test -f $REPORT_DIR/eslint.json || echo "❌ eslint missing"
        test -f $REPORT_DIR/npm_audit.json || echo "❌ npm audit missing"
        test -f $REPORT_DIR/retire.json || echo "❌ retire missing"
        test -f $REPORT_DIR/jscpd.json || echo "❌ jscpd missing"
        test -f $REPORT_DIR/jsdoc.json || echo "❌ jsdoc missing"
        test -f $REPORT_DIR/plato-report/report.json || echo "❌ plato missing"
        
    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: javascript-scan-reports
        path: ${{ env.REPORT_DIR }}/
        retention-days: 30
