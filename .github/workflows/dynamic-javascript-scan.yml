
name: Dynamic JavaScript Code Scan

on:
  workflow_dispatch:
    inputs:
      scan_tools:
        description: 'Comma-separated list of tools to run'
        required: false
        default: 'eslint,plato'
      project_name:
        description: 'Project name for reporting'
        required: false
        default: 'javascript-project'

env:
  REPORT_DIR: scan-reports

jobs:
  javascript-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm install -g eslint plato npm-audit-ci retire
        echo "Verifying installations:"
        eslint --version
        plato --version
        npm-audit-ci --version || echo "npm-audit-ci not available"
        retire --version || echo "retire not available"
        
    - name: Create report directory
      run: mkdir -p $REPORT_DIR
    
    - name: Create ESLint config
      run: |
        cat > .eslintrc.json << 'EOF'
        {
          "env": {
            "browser": true,
            "es2021": true,
            "node": true,
            "commonjs": true
          },
          "extends": ["eslint:recommended"],
          "parserOptions": {
            "ecmaVersion": 12,
            "sourceType": "commonjs"
          },
          "rules": {
            "no-var": "error",
            "semi": "error",
            "no-unused-vars": "warn",
            "no-alert": "error",
            "quotes": ["error", "double"],
            "no-undef": "error"
          }
        }
        EOF
    
    - name: Run JavaScript code scans
      run: |
        echo "Starting JavaScript code scans..."
        echo "Current directory: $(pwd)"
        echo "Report directory: $REPORT_DIR"
        echo "JavaScript files found:"
        find . -name "*.js" -type f | head -10
        echo "=== Running Scan Commands ==="
        echo "DEBUG: Current directory: $(pwd)"
        echo "DEBUG: JavaScript files in current directory:"
        find . -name "*.js" -type f -exec echo "  - {{}}" \;
        echo "DEBUG: About to execute scan_commands..."
        echo 'Running ESLint...'\n        eslint . --format=json --output-file=$REPORT_DIR/eslint.json || true\n        echo 'Running Plato Complexity Analysis...'\n        plato -r -d $REPORT_DIR/plato-report . 2>/dev/null || (mkdir -p $REPORT_DIR/plato-report && echo '{"reports": {}}' > $REPORT_DIR/plato-report/index.json)
        echo "DEBUG: scan_commands completed"
        echo "=== Scan Commands Completed ==="
        echo "Report directory contents after scans:"
        ls -la $REPORT_DIR/
        echo "=== Checking each tool's report file ==="
        echo "ESLint report file:"
        if [ -f "$REPORT_DIR/eslint.json" ]; then
          echo "ESLint report exists"
          echo "ESLint report size: $(wc -c < $REPORT_DIR/eslint.json)"
          echo "ESLint report preview:"
          head -20 $REPORT_DIR/eslint.json
        else
          echo "ESLint report NOT found"
        fi
        echo "Plato report file:"
        if [ -f "$REPORT_DIR/plato-report/index.json" ]; then
          echo "Plato report exists"
          echo "Plato report size: $(wc -c < $REPORT_DIR/plato-report/index.json)"
        else
          echo "Plato report NOT found"
        fi
        
    - name: Generate severity summary
      run: |
        python3 << 'EOF'
        import json
        import os
        from pathlib import Path
        
        report_dir = Path(os.environ.get('REPORT_DIR', 'scan-reports'))
        print("DEBUG: Report directory: " + str(report_dir))
        print("DEBUG: Report directory exists: " + str(report_dir.exists()))
        print("DEBUG: Report directory contents: " + str(list(report_dir.glob('*'))))
        
        # Check which report files exist
        report_files = ['eslint.json', 'plato-report/index.json', 'npm_audit.json', 'retire.json']
        for file_name in report_files:
            file_path = report_dir / file_name
            if file_path.exists():
                print("DEBUG: " + file_name + " exists with size: " + str(file_path.stat().st_size))
            else:
                print("DEBUG: " + file_name + " does not exist")
        
        severity_summary = dict()
        severity_summary['critical'] = []
        severity_summary['high'] = []
        severity_summary['medium'] = []
        severity_summary['low'] = []
        severity_summary['info'] = []
        
        # Process ESLint results
        if (report_dir / 'eslint.json').exists():
            try:
                with open(report_dir / 'eslint.json') as f:
                    eslint_data = json.load(f)
                    print("DEBUG: ESLint data loaded: " + str(len(eslint_data)) + " files processed")
                    
                    for result in eslint_data:
                        if result.get('errorCount', 0) > 0 or result.get('warningCount', 0) > 0:
                            for message in result.get('messages', []):
                                severity = 'high' if message.get('severity') == 2 else 'medium'
                                severity_summary[severity].append(dict(
                                    tool='eslint',
                                    file=result.get('filePath'),
                                    line=message.get('line'),
                                    column=message.get('column'),
                                    issue=message.get('ruleId'),
                                    message=message.get('message')
                                ))
            except Exception as e:
                print("Error processing eslint.json: " + str(e))
        
        # Process Plato results
        plato_report_path = report_dir / 'plato-report' / 'index.json'
        if plato_report_path.exists():
            try:
                with open(plato_report_path) as f:
                    plato_data = json.load(f)
                    print("DEBUG: Plato data loaded")
                    
                    if 'reports' in plato_data:
                        for file_path, report in plato_data['reports'].items():
                            complexity = report.get('complexity', {}).get('aggregate', {}).get('complexity', {}).get('cyclomatic', 0)
                            if complexity > 10:
                                severity_summary['medium'].append(dict(
                                    tool='plato',
                                    file=file_path,
                                    line='N/A',
                                    column='N/A',
                                    issue='high-complexity',
                                    message=f'Cyclomatic complexity: {complexity}'
                                ))
            except Exception as e:
                print("Error processing plato report: " + str(e))
        
        # Process npm-audit results
        if (report_dir / 'npm_audit.json').exists():
            try:
                with open(report_dir / 'npm_audit.json') as f:
                    npm_data = json.load(f)
                    print("DEBUG: NPM audit data loaded")
                    
                    if 'vulnerabilities' in npm_data:
                        for vuln in npm_data['vulnerabilities']:
                            severity = 'high' if vuln.get('severity') in ['high', 'critical'] else 'medium'
                            severity_summary[severity].append(dict(
                                tool='npm_audit',
                                file='package.json',
                                line='N/A',
                                column='N/A',
                                issue=vuln.get('title', 'vulnerability'),
                                message=vuln.get('overview', 'Security vulnerability found')
                            ))
            except Exception as e:
                print("Error processing npm_audit.json: " + str(e))
        
        # Save severity summary
        output_file = report_dir / 'severity_summary.json'
        with open(output_file, 'w') as f:
            json.dump(severity_summary, f, indent=2)
        
        print("DEBUG: Final severity summary:")
        print("Critical: " + str(len(severity_summary['critical'])))
        print("High: " + str(len(severity_summary['high'])))
        print("Medium: " + str(len(severity_summary['medium'])))
        print("Low: " + str(len(severity_summary['low'])))
        print("Info: " + str(len(severity_summary['info'])))
        print("Severity summary saved to: " + str(output_file))
        EOF
        
    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: javascript-scan-reports
        path: ${{ env.REPORT_DIR }}/
        retention-days: 30
        
    - name: Send results to API
      if: always()
      run: |
        if [ -f "$REPORT_DIR/severity_summary.json" ]; then
          curl -X POST \
            -H "Content-Type: application/json" \
            -d @- \
            "https://eop7f15rcm9dnz.m.pipedream.net" << EOF
          {
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "run_id": "${{ github.run_id }}",
            "severity_results": $(cat $REPORT_DIR/severity_summary.json),
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
        fi
EOF